- job:
    block-downstream: false
    block-upstream: false
    builders:
    - shell: |-
        export PRIVATE_KEY=$WORKSPACE/private/config/keys/id_rsa_perf
        chmod 600 $PRIVATE_KEY
        #export KUBECONFIG="/root/.kube/config"
        http_test_dir=/root/http-ci-tests
        ssh_opts="-o StrictHostKeyChecking=no"

        if test "$USE_PROXY" = "true" ; then
        set -- $ssh_opts -o ProxyCommand='ssh -i $PRIVATE_KEY -W %h:%p $PROXY_USER@$PROXY_HOST'
        else
        set -- $ssh_opts
        fi

        ssh "$@" -i $PRIVATE_KEY $JUMP_HOST_USER@$JUMP_HOST <<_SSH_
        sudo su -
        oc login -u system:admin
        rm -rf $http_test_dir
        git clone https://github.com/jmencak/http-ci-tests.git
        cd $http_test_dir
        TEST_CFG=$TEST_CFG
        SETUP_PBENCH=$SETUP_PBENCH
        PBENCH_SERVER=$PBENCH_SERVER
        TOOLING_INVENTORY=$TOOLING_INVENTORY
        CLEAR_RESULTS=$CLEAR_RESULTS
        MOVE_RESULTS=$MOVE_RESULTS
        CONTAINERIZED=$CONTAINERIZED
        GUN=$GUN
        LOAD_GENERATOR_NODES=$LOAD_GENERATOR_NODES
        CL_PROJECTS=$CL_PROJECTS
        CL_TEMPLATES=$CL_TEMPLATES
        SMOKE_TEST=$SMOKE_TEST
        . ./http-test.sh all
        _SSH_
    concurrent: false
    description: Run http(s) tests against HAProxy on an OCP installation.
    disabled: false
    name: !!python/unicode 'http'
    parameters:
    - string:
        default: 1router
        description: 'Test configuration.  Value to append to pbench directories and
          other directories with results.

          '
        name: TEST_CFG
    - string:
        default: b1
        description: The jump host needs to have the inventory used to install openshift
          and kube config.
        name: JUMP_HOST
    - string:
        default: root
        description: The ssh user to connect to the JUMP_HOST.
        name: JUMP_HOST_USER
    - bool:
        default: true
        description: Use the ProxyCommand to access the OpenShift masters.
        name: USE_PROXY
    - string:
        default: perf148a.perf.lab.eng.bos.redhat.com
        description: The server to use for the ssh ProxyCommand.
        name: PROXY_HOST
    - string:
        default: stack
        description: The ssh user to use for the ssh ProxyCommand.
        name: PROXY_USER
    - bool:
        default: true
        description: When enabled, register tools using pbench-ansible.
        name: SETUP_PBENCH
    - string:
        default: ''
        description: If defined, pbench_results_redirector and pbench_web_server will
          be set in "/opt/pbench-agent/config/pbench-agent.cfg".
        name: PBENCH_SERVER
    - string:
        default: /root/tooling_inventory
        description: Path to the inventory generated by openshift_labeler.
        name: TOOLING_INVENTORY
    - bool:
        default: true
        description: When set to true, clear the pbench results from previous pbench
          runs.
        name: CLEAR_RESULTS
    - bool:
        default: false
        description: When enabled, move the benchmark results to a pbench server.
        name: MOVE_RESULTS
    - bool:
        default: false
        description: When enabled, run containerized pbench.
        name: CONTAINERIZED
    - string:
        default: b1.lan
        description: A synchronization endpoint listening at :9090 by default.
        name: GUN
    - string:
        default: b5.lan
        description: Comma separated load-generator nodes.
        name: LOAD_GENERATOR_NODES
    - string:
        default: '10'
        description: Number of projects to create for each type of application (4
          types currently).
        name: CL_PROJECTS
    - string:
        default: '1'
        description: 'Number of templates to create per project.  4*CL_PROJECTS*CL_TEMPLATES
          will be the number of application pods/routes created.

          '
        name: CL_TEMPLATES
    - string:
        default: '120'
        description: Run time of individual HTTP test iterations in seconds.
        name: RUN_TIME
    - bool:
        default: false
        description: Run only a single HTTP test iteration to establish functionality.
        name: SMOKE_TEST
    project-type: freestyle
    properties:
    - build-discarder:
        artifact-days-to-keep: -1
        artifact-num-to-keep: -1
        days-to-keep: -1
        num-to-keep: 5
    - raw:
        xml: |
          <hudson.plugins.disk__usage.DiskUsageProperty plugin="disk-usage@0.28" />
    - raw:
        xml: |
          <com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty plugin="gitlab-plugin@1.5.2">
          <gitLabConnection />
          </com.dabsquared.gitlabjenkins.connection.GitLabConnectionProperty>
    - raw:
        xml: |
          <org.jenkinsci.plugins.ZMQEventPublisher.HudsonNotificationProperty plugin="zmq-event-publisher@0.0.5">
          <enabled>false</enabled>
          </org.jenkinsci.plugins.ZMQEventPublisher.HudsonNotificationProperty>
    - raw:
        xml: |
          <com.synopsys.arc.jenkins.plugins.ownership.jobs.JobOwnerJobProperty plugin="ownership@0.10.0">
          <ownership>
          <ownershipEnabled>true</ownershipEnabled>
          <primaryOwnerId>jmencak</primaryOwnerId>
          <coownersIds class="sorted-set" />
          </ownership>
          </com.synopsys.arc.jenkins.plugins.ownership.jobs.JobOwnerJobProperty>
    - raw:
        xml: |
          <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.25">
          <autoRebuild>false</autoRebuild>
          <rebuildDisabled>false</rebuildDisabled>
          </com.sonyericsson.rebuild.RebuildSettings>
    - raw:
        xml: |
          <hudson.plugins.throttleconcurrents.ThrottleJobProperty plugin="throttle-concurrents@2.0.1">
          <maxConcurrentPerNode>0</maxConcurrentPerNode>
          <maxConcurrentTotal>0</maxConcurrentTotal>
          <categories class="java.util.concurrent.CopyOnWriteArrayList" />
          <throttleEnabled>false</throttleEnabled>
          <throttleOption>project</throttleOption>
          <limitOneJobWithMatchingParams>false</limitOneJobWithMatchingParams>
          <paramsToUseForLimit />
          </hudson.plugins.throttleconcurrents.ThrottleJobProperty>
    publishers: []
    scm:
    - git:
        basedir: private
        branches:
        - '*/master'
        credentials-id: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        url: ssh://openshift-jenkins@code.engineering.redhat.com:22/cucushift-internal
    triggers: []
    wrappers:
    - ansicolor:
        colormap: xterm
